<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Section Swap System</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .card-title {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f1f1f1;
        }
        
        .swap-path {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f4fc;
            border-left: 4px solid var(--primary-color);
            border-radius: 4px;
        }
        
        .swap-path h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .swap-step {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }
        
        .swap-step:before {
            content: "→";
            position: absolute;
            left: 0;
            color: var(--accent-color);
        }
          .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: var(--light-color);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid var(--primary-color);
        }
        
        .stat-card h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        
        .stat-card p {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--dark-color);
        }
        
        .dashboard-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .dashboard-actions button {
            flex: 1;
            min-width: 120px;
        }
        
        .btn-danger {
            background-color: var(--accent-color);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .table-responsive {
            overflow-x: auto;
        }
        
        .hidden {
            display: none;
        }
        
        .error {
            color: var(--accent-color);
            margin-top: 5px;
            font-size: 0.9rem;
        }
        
        .section-badge {
            background-color: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-satisfied {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-looking {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-no-preference {
            background-color: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }
        
        /* Desired Sections Styling */
        #desired-sections-container {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background-color: #f9f9f9;
        }
        
        .desired-section-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background-color: white;
            border-radius: 3px;
            border: 1px solid #e9ecef;
        }
        
        .desired-section-item:last-child {
            margin-bottom: 0;
        }
        
        .desired-section-select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            margin-right: 10px;
        }
        
        .remove-section {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            line-height: 1;
        }
        
        .remove-section:hover {
            background-color: #c82333;
        }
        
        .priority-indicator {
            background-color: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 10px;
            min-width: 20px;
            text-align: center;
        }
        
        #dash-desired-sections .priority-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        #dash-desired-sections .priority-item {
            display: flex;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        #dash-desired-sections .priority-item:last-child {
            border-bottom: none;
        }
        
        /* Sheet Controls Styling */
        .sheet-controls {
            border: 1px solid #dee2e6;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            min-width: 150px;
        }
        
        .control-group label {
            white-space: nowrap;
            margin-bottom: 0;
        }
        
        .control-group select {
            border: 1px solid #ddd;
            border-radius: 3px;
            background-color: white;
        }
        
        /* Table styling improvements */
        #swap-sheet-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        #swap-sheet-table th,
        #swap-sheet-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        #swap-sheet-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        #swap-sheet-table tbody tr:hover {
            background-color: #f5f5f5;
        }
        
        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        
        .available-swaps-section {
            background: linear-gradient(135deg, #e3f2fd 0%, #f1f8e9 100%);
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .available-swaps-section h3 {
            margin-top: 0;
            color: #2e7d32 !important;
        }

        .swap-opportunity {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #4caf50;
        }

        .swap-opportunity h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }

        .swap-partners {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .swap-partner {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 8px 12px;
            font-size: 14px;
        }

        .swap-partner strong {
            color: #1976d2;
        }

        .swap-path {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .swap-step {
            display: flex;
            align-items: center;
            margin: 10px 0;
            position: relative;
        }

        .step-number {
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .step-details {
            flex: 1;
        }

        .step-sections {
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 5px;
        }

        .step-student {
            font-size: 14px;
            color: #666;
        }

        .step-arrow {
            text-align: center;
            font-size: 20px;
            color: #007bff;
            margin: 5px 0;
            margin-left: 45px;
        }

        .multi-swap-summary {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            color: #1976d2;
        }

        .swap-opportunity[data-type="multi"] {
            border-left-color: #ff9800;
        }

        .swap-opportunity[data-type="direct"] {
            border-left-color: #4caf50;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header {
                padding: 15px 0;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Student Section Swap System</h1>
            <p class="subtitle">Exchange sections with other students efficiently</p>
        </div>
    </header>
      <div class="container">
        <!-- Login Card -->
        <div class="card" id="login-card">
            <h2 class="card-title">Student Login</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-roll-number">Roll Number</label>
                    <input type="text" id="login-roll-number" required placeholder="Enter your roll number">
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required placeholder="Enter your password">
                </div>
                <button type="submit">Login</button>
                <div class="form-group" style="margin-top: 15px;">
                    <p>Don't have an account? <a href="#" id="show-register">Register here</a></p>
                </div>
            </form>
        </div>

        <!-- Registration Card -->
        <div class="card hidden" id="register-card">
            <h2 class="card-title">Student Registration</h2>
            <form id="register-form">
                <div class="form-group">
                    <label for="reg-roll-number">Roll Number</label>
                    <input type="text" id="reg-roll-number" required placeholder="Enter your roll number">
                </div>
                <div class="form-group">
                    <label for="reg-name">Full Name</label>
                    <input type="text" id="reg-name" required placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label for="reg-phone">Phone Number</label>
                    <input type="tel" id="reg-phone" required placeholder="Enter your phone number">
                </div>
                <div class="form-group">
                    <label for="reg-email">Email (Optional)</label>
                    <input type="email" id="reg-email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="reg-password">Password</label>
                    <input type="password" id="reg-password" required placeholder="Create a password">
                </div>
                <div class="form-group">
                    <label for="reg-current-section">Current Section</label>
                    <select id="reg-current-section" required>
                        <option value="">Select your current section</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reg-desired-sections">Desired Sections (Optional)</label>
                    <div id="reg-desired-sections-container">
                        <div class="desired-section-item">
                            <select class="desired-section-select">
                                <option value="">Select section</option>
                            </select>
                            <button type="button" class="remove-section" onclick="removeDesiredSection(this)" style="display:none;">×</button>
                        </div>
                    </div>
                    <button type="button" id="reg-add-desired-section" class="btn-secondary" style="margin-top: 10px;">+ Add Section</button>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">Add sections in order of preference. You can add these later in your profile.</p>
                </div>
                <button type="submit">Register</button>
                <div class="form-group" style="margin-top: 15px;">
                    <p>Already have an account? <a href="#" id="show-login">Login here</a></p>
                </div>
            </form>
        </div>

        <!-- Dashboard Card -->
        <div class="card hidden" id="dashboard-card">
            <h2 class="card-title">Dashboard</h2>
            <div class="dashboard-stats">
                <div class="stat-card">
                    <h3>Current Section</h3>
                    <p id="dash-current-section">-</p>
                </div>
                <div class="stat-card">
                    <h3>Desired Sections</h3>
                    <div id="dash-desired-sections">
                        <p>No sections set</p>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>Pending Requests</h3>
                    <p id="dash-pending-requests">0</p>
                </div>
                <div class="stat-card">
                    <h3>Total Swaps</h3>
                    <p id="dash-total-swaps">0</p>
                </div>
            </div>
            
            <!-- Available Swaps Section -->
            <div id="available-swaps-section" class="available-swaps-section" style="margin: 20px 0; display: none;">
                <h3 style="color: #007bff; margin-bottom: 15px;">🎉 Available Direct Swaps</h3>
                <div id="available-swaps-list"></div>
            </div>
            
            <div class="dashboard-actions">
                <button id="view-profile-btn" class="btn-success">View Profile</button>
                <button id="find-swap-dashboard-btn">Find Swap</button>
                <button id="find-all-swaps-dashboard-btn" class="btn-primary">Auto-Find Swaps</button>
                <button id="view-sheet-btn">View Swap Sheet</button>
                <button id="logout-btn" class="btn-danger">Logout</button>
            </div>
        </div>

        <!-- Profile Card -->
        <div class="card hidden" id="profile-card">
            <h2 class="card-title">Student Profile</h2>
            <form id="profile-form">
                <div class="form-group">
                    <label for="profile-roll">Roll Number</label>
                    <input type="text" id="profile-roll" readonly>
                </div>
                <div class="form-group">
                    <label for="profile-name">Full Name</label>
                    <input type="text" id="profile-name" required>
                </div>
                <div class="form-group">
                    <label for="profile-phone">Phone Number</label>
                    <input type="tel" id="profile-phone" required>
                </div>
                <div class="form-group">
                    <label for="profile-email">Email</label>
                    <input type="email" id="profile-email">
                </div>
                <div class="form-group">
                    <label for="profile-current-section">Current Section</label>
                    <input type="text" id="profile-current-section" readonly>
                </div>
                <div class="form-group">
                    <label for="profile-desired-sections">Desired Sections (Priority Order)</label>
                    <div id="desired-sections-container">
                        <div class="desired-section-item">
                            <select class="desired-section-select">
                                <option value="">Select section</option>
                            </select>
                            <button type="button" class="remove-section" onclick="removeDesiredSection(this)" style="display:none;">×</button>
                        </div>
                    </div>
                    <button type="button" id="add-desired-section" class="btn-secondary" style="margin-top: 10px;">+ Add Section</button>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">Add sections in order of preference. First section = highest priority.</p>
                </div>
                <button type="submit" class="btn-success">Update Profile</button>
                <button type="button" id="back-to-dashboard">Back to Dashboard</button>
            </form>
        </div>

        <!-- Swap Sheet Card -->
        <div class="card hidden" id="sheet-card">
            <h2 class="card-title">Student Swap Sheet</h2>
            
            <!-- Filter and Sort Controls -->
            <div class="sheet-controls" style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 5px;">
                <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                    <div class="control-group">
                        <label for="section-filter" style="margin-right: 5px; font-weight: bold;">Filter by Section:</label>
                        <select id="section-filter" style="padding: 5px;">
                            <option value="">All Sections</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label for="status-filter" style="margin-right: 5px; font-weight: bold;">Filter by Status:</label>
                        <select id="status-filter" style="padding: 5px;">
                            <option value="">All Status</option>
                            <option value="Looking for swap">Looking for swap</option>
                            <option value="Satisfied">Satisfied</option>
                            <option value="No preference">No preference</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label for="sort-by" style="margin-right: 5px; font-weight: bold;">Sort by:</label>
                        <select id="sort-by" style="padding: 5px;">
                            <option value="roll_number">Roll Number</option>
                            <option value="name">Name</option>
                            <option value="current_section">Current Section</option>
                            <option value="status">Status</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <button id="sort-order-btn" class="btn-secondary" style="padding: 5px 10px;">
                            ↑ Ascending
                        </button>
                    </div>
                    
                    <div class="control-group">
                        <button id="clear-filters-btn" class="btn-secondary" style="padding: 5px 10px;">
                            Clear Filters
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table id="swap-sheet-table">
                    <thead>
                        <tr>
                            <th>Roll Number</th>
                            <th>Name</th>
                            <th>Current Section</th>
                            <th>Desired Sections</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="swap-sheet-body">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 15px;">
                <span id="table-info" style="font-size: 14px; color: #666;"></span>
            </div>
            <button type="button" id="back-to-dashboard-from-sheet">Back to Dashboard</button>
        </div>
        
        <div class="card hidden" id="swap-card">
            <h2 class="card-title">Section Swap Request</h2>
            <div class="form-group">
                <label for="current-section">Your Current Section</label>
                <input type="text" id="current-section" readonly>
            </div>
            <div class="form-group">
                <label for="desired-section">Desired Section</label>
                <select id="desired-section" required>
                    <option value="">Select desired section</option>
                    <!-- Sections will be populated dynamically -->
                </select>
            </div>
            <div class="form-group">
                <button id="find-swap-btn" class="btn-primary">Find Swap for Specific Section</button>
                <button id="find-all-swaps-btn" class="btn-success" style="margin-top: 10px;">Find All Available Swaps (Priority Order)</button>
            </div>
            
            <div id="swap-results" class="hidden">
                <h3>Swap Options</h3>
                <div id="direct-swap" class="hidden">
                    <p>Direct swap available!</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Current Section</th>
                                <th>Desired Section</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="direct-swap-table">
                            <!-- Direct swap info will be added here -->
                        </tbody>
                    </table>
                    <button id="confirm-direct-swap" class="btn-success">Confirm Direct Swap</button>
                </div>
                
                <div id="multi-swap" class="hidden">
                    <p>No direct swap available, but we found a multi-step swap path:</p>
                    <div class="swap-path">
                        <h3>Swap Path</h3>
                        <div id="swap-steps">
                            <!-- Swap steps will be added here -->
                        </div>
                    </div>
                    <button id="confirm-multi-swap" class="btn-success">Confirm Multi-Swap</button>
                </div>
                
                <div id="no-swap" class="hidden">
                    <p>No swap options available at this time. Please check back later.</p>
                </div>
            </div>
        </div>
        
        <div class="card hidden" id="confirmation-card">
            <h2 class="card-title">Swap Confirmation</h2>
            <div id="confirmation-message"></div>
            <button id="back-to-swap">Back to Swap</button>
        </div>
    </div>
    
    <footer>
        <div class="container">
            <p>© 2025 Student Section Swap System. All rights reserved.</p>
            <div style="margin-top: 15px; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; font-size: 14px; line-height: 1.5;">
                <strong>⚠️ Disclaimer:</strong> This is <strong>NOT an official KIIT website</strong>. 
                This platform is designed to help students find potential section swap partners for <strong>FREE</strong>. 
                Once you find a suitable swap partner, please complete the section swap process through 
                <strong>official KIIT channels and procedures</strong>. Always verify with your academic office 
                before making any section changes.
            </div>
        </div>
    </footer>    <script>
        // API Base URL - automatically detect environment
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000/api' 
            : 'https://section-swap-kiit.onrender.com/api';
        
        console.log('Using API Base:', API_BASE);
        
        // Authentication token
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;

        // All possible sections (1-50)
        const allSections = Array.from({length: 50}, (_, i) => (i + 1).toString());

        // DOM elements
        const loginCard = document.getElementById('login-card');
        const registerCard = document.getElementById('register-card');
        const dashboardCard = document.getElementById('dashboard-card');
        const profileCard = document.getElementById('profile-card');
        const sheetCard = document.getElementById('sheet-card');
        const swapCard = document.getElementById('swap-card');
        const confirmationCard = document.getElementById('confirmation-card');

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            populateAllSectionSelects();
            
            if (authToken) {
                validateTokenAndShowDashboard();
            } else {
                showLogin();
            }
            
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Login/Register toggles
            document.getElementById('show-register').addEventListener('click', (e) => {
                e.preventDefault();
                showRegister();
            });
            
            document.getElementById('show-login').addEventListener('click', (e) => {
                e.preventDefault();
                showLogin();
            });

            // Forms
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('profile-form').addEventListener('submit', handleProfileUpdate);

            // Dashboard buttons
            document.getElementById('view-profile-btn').addEventListener('click', showProfile);
            document.getElementById('find-swap-dashboard-btn').addEventListener('click', showSwapCard);
            document.getElementById('find-all-swaps-dashboard-btn').addEventListener('click', findAllSwapsFromDashboard);
            document.getElementById('view-sheet-btn').addEventListener('click', showSwapSheet);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);

            // Back buttons
            document.getElementById('back-to-dashboard').addEventListener('click', showDashboard);
            document.getElementById('back-to-dashboard-from-sheet').addEventListener('click', showDashboard);

            // Existing swap functionality
            document.getElementById('find-swap-btn').addEventListener('click', findSwapOptions);
            document.getElementById('find-all-swaps-btn').addEventListener('click', findAllSwapsFromCard);
            document.getElementById('confirm-direct-swap').addEventListener('click', confirmDirectSwap);
            document.getElementById('confirm-multi-swap').addEventListener('click', confirmMultiSwap);
            document.getElementById('back-to-swap').addEventListener('click', showSwapCard);
            
            // Sheet filter and sort controls
            document.getElementById('section-filter').addEventListener('change', applyFilters);
            document.getElementById('status-filter').addEventListener('change', applyFilters);
            document.getElementById('sort-by').addEventListener('change', applySorting);
            document.getElementById('sort-order-btn').addEventListener('click', toggleSortOrder);
            document.getElementById('clear-filters-btn').addEventListener('click', clearFilters);
        }

        // API Functions
        async function apiCall(endpoint, method = 'GET', data = null) {
            const config = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };

            if (authToken) {
                config.headers['Authorization'] = `Bearer ${authToken}`;
            }

            if (data) {
                config.body = JSON.stringify(data);
            }

            try {
                console.log('Making API call to:', API_BASE + endpoint);
                const response = await fetch(API_BASE + endpoint, config);
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response received:', text);
                    throw new Error(`Server error: Expected JSON but got ${contentType}. Check if server is running properly.`);
                }
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                return result;
            } catch (error) {
                console.error('API Error:', error);
                console.error('Full URL:', API_BASE + endpoint);
                console.error('Response status:', error.status);
                throw error;
            }
        }

        // Authentication functions
        async function handleLogin(e) {
            e.preventDefault();
            
            const rollNumber = document.getElementById('login-roll-number').value.trim();
            const password = document.getElementById('login-password').value;

            try {
                const result = await apiCall('/login', 'POST', { rollNumber, password });
                
                authToken = result.token;
                localStorage.setItem('authToken', authToken);
                currentUser = result.student;
                
                showDashboard();
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            
            const desiredSections = getDesiredSectionsFromContainer('reg-desired-sections-container');
            
            const data = {
                rollNumber: document.getElementById('reg-roll-number').value.trim(),
                name: document.getElementById('reg-name').value.trim(),
                phoneNumber: document.getElementById('reg-phone').value.trim(),
                email: document.getElementById('reg-email').value.trim(),
                password: document.getElementById('reg-password').value,
                currentSection: document.getElementById('reg-current-section').value,
                desiredSections: desiredSections
            };

            try {
                await apiCall('/register', 'POST', data);
                alert('Registration successful! Please login.');
                showLogin();
            } catch (error) {
                alert('Registration failed: ' + error.message);
            }
        }

        async function validateTokenAndShowDashboard() {
            try {
                const profile = await apiCall('/profile');
                currentUser = profile;
                showDashboard();
            } catch (error) {
                localStorage.removeItem('authToken');
                authToken = null;
                showLogin();
            }
        }

        function handleLogout() {
            localStorage.removeItem('authToken');
            authToken = null;
            currentUser = null;
            showLogin();
        }

        // Profile functions
        async function showProfile() {
            try {
                const profile = await apiCall('/profile');
                
                document.getElementById('profile-roll').value = profile.roll_number;
                document.getElementById('profile-name').value = profile.name;
                document.getElementById('profile-phone').value = profile.phone_number;
                document.getElementById('profile-email').value = profile.email || '';
                document.getElementById('profile-current-section').value = profile.current_section;
                
                // Populate desired sections container
                const desiredSections = profile.desired_sections || [];
                populateDesiredSectionsContainer('desired-sections-container', desiredSections, profile.current_section);
                
                hideAllCards();
                profileCard.classList.remove('hidden');
            } catch (error) {
                alert('Failed to load profile: ' + error.message);
            }
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();
            
            const desiredSections = getDesiredSectionsFromContainer('desired-sections-container');
            
            const data = {
                name: document.getElementById('profile-name').value.trim(),
                phoneNumber: document.getElementById('profile-phone').value.trim(),
                email: document.getElementById('profile-email').value.trim(),
                desiredSections: desiredSections
            };

            try {
                await apiCall('/profile', 'PUT', data);
                alert('Profile updated successfully!');
                showDashboard();
            } catch (error) {
                alert('Failed to update profile: ' + error.message);
            }
        }

        // Dashboard functions with retry mechanism
        async function showDashboard(retryCount = 0) {
            try {
                console.log('Loading dashboard... (attempt', retryCount + 1, ')');
                const dashboardData = await apiCall('/dashboard');
                
                document.getElementById('dash-current-section').textContent = dashboardData.student.current_section;
                
                // Display desired sections with priority
                displayDesiredSectionsInDashboard(dashboardData.student.desired_sections);
                
                document.getElementById('dash-pending-requests').textContent = dashboardData.pendingRequests;
                document.getElementById('dash-total-swaps').textContent = dashboardData.totalSwaps;
                
                // Display available swaps
                displayAvailableSwaps(dashboardData.availableSwaps || []);
                
                currentUser = dashboardData.student;
                
                hideAllCards();
                dashboardCard.classList.remove('hidden');
                console.log('Dashboard loaded successfully');
            } catch (error) {
                console.error('Dashboard error:', error);
                
                // Retry once after 2 seconds if it's the first attempt
                if (retryCount === 0) {
                    console.log('Retrying dashboard load in 2 seconds...');
                    setTimeout(() => showDashboard(1), 2000);
                    
                    // Show loading state
                    hideAllCards();
                    dashboardCard.classList.remove('hidden');
                    document.getElementById('dash-current-section').textContent = 'Loading...';
                    document.getElementById('dash-pending-requests').textContent = '-';
                    document.getElementById('dash-total-swaps').textContent = '-';
                    return;
                }
                
                // Show error after retry failed
                alert(`Failed to load dashboard: ${error.message}\n\nPlease check your internet connection and try refreshing the page.`);
                
                // Show error state on dashboard
                hideAllCards();
                dashboardCard.classList.remove('hidden');
                document.getElementById('dash-current-section').textContent = 'Error loading data';
                document.getElementById('dash-pending-requests').textContent = '-';
                document.getElementById('dash-total-swaps').textContent = '-';
                
                // Clear desired sections
                const container = document.getElementById('dash-desired-sections');
                container.innerHTML = '<p style="color: #dc3545;">Failed to load sections</p>';
            }
        }

        // Global variables for filtering and sorting
        let allStudentsData = [];
        let currentSortColumn = 'roll_number';
        let currentSortOrder = 'asc';

        async function showSwapSheet() {
            try {
                const dashboardData = await apiCall('/dashboard');
                allStudentsData = dashboardData.allStudents.map(student => {
                    // Handle desired sections array
                    const desiredSections = student.desired_sections || [];
                    const hasDesiredSections = desiredSections.length > 0;
                    
                    const status = !hasDesiredSections ? 'No preference' : 
                                  desiredSections.includes(student.current_section) ? 'Satisfied' : 
                                  'Looking for swap';
                    
                    return {
                        ...student,
                        status: status,
                        desired_sections: desiredSections
                    };
                });
                
                // Populate section filter dropdown
                populateSectionFilter();
                
                // Display the data
                displayFilteredStudents(allStudentsData);
                
                hideAllCards();
                sheetCard.classList.remove('hidden');
            } catch (error) {
                alert('Failed to load swap sheet: ' + error.message);
            }
        }

        function populateSectionFilter() {
            const sectionFilter = document.getElementById('section-filter');
            sectionFilter.innerHTML = '<option value="">All Sections</option>';
            
            // Get unique sections
            const sections = new Set();
            allStudentsData.forEach(student => {
                sections.add(student.current_section);
                student.desired_sections.forEach(section => sections.add(section));
            });
            
            // Sort sections
            const sortedSections = Array.from(sections).sort();
            sortedSections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionFilter.appendChild(option);
            });
        }

        function displayFilteredStudents(students) {
            const tbody = document.getElementById('swap-sheet-body');
            tbody.innerHTML = '';
            
            students.forEach(student => {
                const row = document.createElement('tr');
                
                const statusClass = student.status === 'Satisfied' ? 'status-satisfied' : 
                                   student.status === 'Looking for swap' ? 'status-looking' : 'status-no-preference';
                
                // Format desired sections display
                const desiredDisplay = student.desired_sections.length > 0 ? 
                    student.desired_sections.map((section, index) => 
                        `<span class="section-badge" title="Priority ${index + 1}">${section}</span>`
                    ).join(' ') : '-';
                
                row.innerHTML = `
                    <td>${student.roll_number}</td>
                    <td>${student.name}</td>
                    <td><span class="section-badge">${student.current_section}</span></td>
                    <td>${desiredDisplay}</td>
                    <td><span class="status-badge ${statusClass}">${student.status}</span></td>
                `;
                tbody.appendChild(row);
            });
            
            // Update table info
            updateTableInfo(students.length, allStudentsData.length);
        }

        function updateTableInfo(filteredCount, totalCount) {
            const tableInfo = document.getElementById('table-info');
            tableInfo.textContent = `Showing ${filteredCount} of ${totalCount} students`;
        }

        function applyFilters() {
            const sectionFilter = document.getElementById('section-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            
            let filteredStudents = allStudentsData.filter(student => {
                // Section filter
                if (sectionFilter && 
                    student.current_section !== sectionFilter && 
                    !student.desired_sections.includes(sectionFilter)) {
                    return false;
                }
                
                // Status filter
                if (statusFilter && student.status !== statusFilter) {
                    return false;
                }
                
                return true;
            });
            
            // Apply current sorting
            filteredStudents = sortStudents(filteredStudents, currentSortColumn, currentSortOrder);
            
            displayFilteredStudents(filteredStudents);
        }

        function applySorting() {
            const sortBy = document.getElementById('sort-by').value;
            currentSortColumn = sortBy;
            applyFilters(); // This will apply both filters and sorting
        }

        function toggleSortOrder() {
            const sortOrderBtn = document.getElementById('sort-order-btn');
            currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            sortOrderBtn.textContent = currentSortOrder === 'asc' ? '↑ Ascending' : '↓ Descending';
            applyFilters(); // This will apply both filters and sorting
        }

        function sortStudents(students, column, order) {
            return students.sort((a, b) => {
                let aVal, bVal;
                
                switch(column) {
                    case 'roll_number':
                        aVal = a.roll_number;
                        bVal = b.roll_number;
                        break;
                    case 'name':
                        aVal = a.name.toLowerCase();
                        bVal = b.name.toLowerCase();
                        break;
                    case 'current_section':
                        aVal = a.current_section;
                        bVal = b.current_section;
                        break;
                    case 'status':
                        aVal = a.status;
                        bVal = b.status;
                        break;
                    default:
                        return 0;
                }
                
                if (aVal < bVal) return order === 'asc' ? -1 : 1;
                if (aVal > bVal) return order === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function clearFilters() {
            document.getElementById('section-filter').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('sort-by').value = 'roll_number';
            currentSortColumn = 'roll_number';
            currentSortOrder = 'asc';
            document.getElementById('sort-order-btn').textContent = '↑ Ascending';
            
            // Display all students with default sorting
            const sortedStudents = sortStudents([...allStudentsData], currentSortColumn, currentSortOrder);
            displayFilteredStudents(sortedStudents);
        }

        // Swap functions
        function showSwapCard() {
            document.getElementById('current-section').value = currentUser.current_section;
            populateSections();
            hideAllCards();
            swapCard.classList.remove('hidden');
        }

        async function findSwapOptions() {
            const desiredSection = document.getElementById('desired-section').value;
            
            if (!desiredSection) {
                document.getElementById('section-error').textContent = 'Please select a desired section';
                document.getElementById('section-error').classList.remove('hidden');
                return;
            }
            
            document.getElementById('section-error').classList.add('hidden');
            
            try {
                const result = await apiCall('/find-swap', 'POST', { desiredSection });
                
                // Hide all result sections
                document.getElementById('swap-results').classList.remove('hidden');
                document.getElementById('direct-swap').classList.add('hidden');
                document.getElementById('multi-swap').classList.add('hidden');
                document.getElementById('no-swap').classList.add('hidden');
                
                if (result.type === 'direct') {
                    showDirectSwap(result.partner);
                } else if (result.type === 'multi') {
                    showMultiSwap(result.path);
                } else {
                    document.getElementById('no-swap').classList.remove('hidden');
                }
            } catch (error) {
                alert('Failed to find swap options: ' + error.message);
            }
        }

        function showDirectSwap(partner) {
            document.getElementById('direct-swap-table').innerHTML = `
                <tr>
                    <td>${partner.roll_number}</td>
                    <td>${partner.current_section}</td>
                    <td>${partner.desired_section}</td>
                    <td>Direct swap with you</td>
                </tr>
            `;
            document.getElementById('direct-swap').classList.remove('hidden');
        }

        function showMultiSwap(path) {
            const swapSteps = document.getElementById('swap-steps');
            swapSteps.innerHTML = '';
            
            path.forEach((step, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'swap-step';
                
                if (index === 0) {
                    stepDiv.textContent = `You give section ${step.from} and take section ${step.to}`;
                } else {
                    const student = step.student;
                    stepDiv.textContent = `${student ? student.roll_number : 'Unknown'} gives section ${step.from} and takes section ${step.to}`;
                }
                
                swapSteps.appendChild(stepDiv);
            });
            
            document.getElementById('multi-swap').classList.remove('hidden');
        }

        async function confirmDirectSwap() {
            const desiredSection = document.getElementById('desired-section').value;
            
            try {
                await apiCall('/swap-request', 'POST', {
                    targetSection: desiredSection,
                    swapType: 'direct'
                });
                
                document.getElementById('confirmation-message').innerHTML = `
                    <p>Direct swap request submitted successfully!</p>
                    <p><strong>Target section:</strong> ${desiredSection}</p>
                    <p>The system will coordinate the swap automatically.</p>
                `;
                
                hideAllCards();
                confirmationCard.classList.remove('hidden');
            } catch (error) {
                alert('Failed to confirm swap: ' + error.message);
            }
        }

        async function confirmMultiSwap() {
            const desiredSection = document.getElementById('desired-section').value;
            
            try {
                const result = await apiCall('/find-swap', 'POST', { desiredSection });
                
                await apiCall('/swap-request', 'POST', {
                    targetSection: desiredSection,
                    swapType: 'multi',
                    swapPath: result.path
                });
                
                document.getElementById('confirmation-message').innerHTML = `
                    <p>Multi-step swap request submitted successfully!</p>
                    <p><strong>Target section:</strong> ${desiredSection}</p>
                    <p>The system will coordinate these swaps automatically.</p>
                `;
                
                hideAllCards();
                confirmationCard.classList.remove('hidden');
            } catch (error) {
                alert('Failed to confirm multi-swap: ' + error.message);
            }
        }

        // Utility functions
        function hideAllCards() {
            document.querySelectorAll('.card').forEach(card => {
                card.classList.add('hidden');
            });
        }

        function showLogin() {
            hideAllCards();
            loginCard.classList.remove('hidden');
        }

        function showRegister() {
            hideAllCards();
            registerCard.classList.remove('hidden');
        }

        function populateAllSectionSelects() {
            const selects = ['reg-current-section', 'desired-section'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    allSections.forEach(section => {
                        const option = document.createElement('option');
                        option.value = section;
                        option.textContent = section;
                        select.appendChild(option);
                    });
                }
            });
            
            // Initialize desired sections containers with section options
            setTimeout(() => {
                populateDesiredSectionsContainer('reg-desired-sections-container', ['']);
                populateDesiredSectionsContainer('desired-sections-container', ['']);
            }, 100);
        }

        function populateSections() {
            const desiredSelect = document.getElementById('desired-section');
            desiredSelect.innerHTML = '<option value="">Select desired section</option>';
            
            allSections.forEach(section => {
                if (section !== currentUser.current_section) {
                    const option = document.createElement('option');
                    option.value = section;
                    option.textContent = section;
                    desiredSelect.appendChild(option);
                }
            });
        }

        // Functions for handling multiple desired sections
        function addDesiredSection(containerId, addButtonId) {
            const container = document.getElementById(containerId);
            const newItem = document.createElement('div');
            newItem.className = 'desired-section-item';
            
            newItem.innerHTML = `
                <select class="desired-section-select">
                    <option value="">Select section</option>
                    ${allSections.map(section => `<option value="${section}">${section}</option>`).join('')}
                </select>
                <button type="button" class="remove-section" onclick="removeDesiredSection(this)">×</button>
            `;
            
            container.appendChild(newItem);
            updateRemoveButtonsVisibility(containerId);
        }

        function removeDesiredSection(button) {
            const item = button.parentElement;
            const container = item.parentElement;
            const containerId = container.id;
            
            item.remove();
            updateRemoveButtonsVisibility(containerId);
        }

        function updateRemoveButtonsVisibility(containerId) {
            const container = document.getElementById(containerId);
            const items = container.querySelectorAll('.desired-section-item');
            
            items.forEach((item, index) => {
                const removeBtn = item.querySelector('.remove-section');
                removeBtn.style.display = items.length > 1 ? 'flex' : 'none';
            });
        }

        function getDesiredSectionsFromContainer(containerId) {
            const container = document.getElementById(containerId);
            const selects = container.querySelectorAll('.desired-section-select');
            const sections = [];
            
            selects.forEach(select => {
                if (select.value && select.value.trim() !== '') {
                    sections.push(select.value);
                }
            });
            
            // Remove duplicates while preserving order
            return [...new Set(sections)];
        }

        function populateDesiredSectionsContainer(containerId, sections = [], currentSection = null) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (sections.length === 0) {
                sections = [''];
            }
            
            sections.forEach((section, index) => {
                const item = document.createElement('div');
                item.className = 'desired-section-item';
                
                const select = document.createElement('select');
                select.className = 'desired-section-select';
                
                // Add default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select section';
                select.appendChild(defaultOption);
                
                // Add all sections except current
                allSections.forEach(sectionNum => {
                    if (sectionNum !== currentSection) {
                        const option = document.createElement('option');
                        option.value = sectionNum;
                        option.textContent = sectionNum;
                        option.selected = sectionNum === section;
                        select.appendChild(option);
                    }
                });
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-section';
                removeBtn.textContent = '×';
                removeBtn.onclick = () => removeDesiredSection(removeBtn);
                removeBtn.style.display = sections.length > 1 ? 'flex' : 'none';
                
                item.appendChild(select);
                item.appendChild(removeBtn);
                container.appendChild(item);
            });
        }

        function displayDesiredSectionsInDashboard(sections) {
            const container = document.getElementById('dash-desired-sections');
            
            if (!sections || sections.length === 0) {
                container.innerHTML = '<p>No sections set</p>';
                return;
            }
            
            const listHtml = sections.map((section, index) => 
                `<div class="priority-item">
                    <span class="priority-indicator">${index + 1}</span>
                    <span>Section ${section}</span>
                </div>`
            ).join('');
            
            container.innerHTML = `<div class="priority-list">${listHtml}</div>`;
        }

        function displayAvailableSwaps(availableSwaps) {
            const section = document.getElementById('available-swaps-section');
            const list = document.getElementById('available-swaps-list');
            
            if (!availableSwaps || availableSwaps.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            list.innerHTML = '';
            
            availableSwaps.forEach(swap => {
                const swapDiv = document.createElement('div');
                swapDiv.className = 'swap-opportunity';
                swapDiv.setAttribute('data-type', swap.type || 'direct');
                
                if (swap.type === 'direct' || (!swap.type && swap.partners)) {
                    // Direct swap display (including legacy format)
                    const partnersHtml = swap.partners.map(partner => 
                        `<div class="swap-partner">
                            <strong>${partner.name}</strong> (${partner.roll_number})
                            <br>Section ${partner.current_section}
                        </div>`
                    ).join('');
                    
                    swapDiv.innerHTML = `
                        <h4>🔄 Direct Swap to Section ${swap.targetSection}</h4>
                        <p><strong>Available Partners:</strong></p>
                        <div class="swap-partners">
                            ${partnersHtml}
                        </div>
                        <p style="margin-top: 10px; font-size: 14px; color: #666;">
                            💡 <strong>Action Required:</strong> Contact these students directly to arrange your section swap through official KIIT procedures.
                        </p>
                    `;
                } else if (swap.type === 'multi') {
                    // Multi-step swap display
                    const pathHtml = swap.path.map((step, index) => {
                        const studentInfo = step.student ? 
                            `<strong>${step.student.name}</strong> (${step.student.roll_number})` : 
                            'Multiple Students';
                        
                        return `
                            <div class="swap-step">
                                <div class="step-number">${index + 1}</div>
                                <div class="step-details">
                                    <div class="step-sections">Section ${step.from} → Section ${step.to}</div>
                                    <div class="step-student">${studentInfo}</div>
                                </div>
                                ${index < swap.path.length - 1 ? '<div class="step-arrow">↓</div>' : ''}
                            </div>
                        `;
                    }).join('');
                    
                    swapDiv.innerHTML = `
                        <h4>🔀 Multi-Step Swap to Section ${swap.targetSection}</h4>
                        <p><strong>Swap Sequence:</strong></p>
                        <div class="swap-path">
                            ${pathHtml}
                        </div>
                        <div class="multi-swap-summary">
                            <strong>Result:</strong> You'll get Section ${swap.targetSection} through ${swap.path.length} swap steps
                        </div>
                        <p style="margin-top: 10px; font-size: 14px; color: #666;">
                            💡 <strong>Action Required:</strong> Contact the first student in the sequence to initiate this multi-step swap through official KIIT procedures.
                        </p>
                    `;
                }
                
                list.appendChild(swapDiv);
            });
        }

        // Setup event listeners for add buttons
        document.addEventListener('DOMContentLoaded', function() {
            // Add button for profile form
            document.getElementById('add-desired-section')?.addEventListener('click', () => {
                addDesiredSection('desired-sections-container', 'add-desired-section');
            });
            
            // Add button for registration form
            document.getElementById('reg-add-desired-section')?.addEventListener('click', () => {
                addDesiredSection('reg-desired-sections-container', 'reg-add-desired-section');
            });
        });

        // New functions for finding swaps across all desired sections
        async function findAllSwapsFromDashboard() {
            try {
                const result = await apiCall('/find-all-swaps', 'POST');
                displayAllSwapResults(result);
                hideAllCards();
                swapCard.classList.remove('hidden');
            } catch (error) {
                alert('Failed to find swaps: ' + error.message);
            }
        }

        async function findAllSwapsFromCard() {
            try {
                const result = await apiCall('/find-all-swaps', 'POST');
                displayAllSwapResults(result);
            } catch (error) {
                alert('Failed to find swaps: ' + error.message);
            }
        }

        function displayAllSwapResults(result) {
            const resultsDiv = document.getElementById('swap-results');
            resultsDiv.classList.remove('hidden');
            
            if (result.type === 'none') {
                resultsDiv.innerHTML = `
                    <h3>No Swaps Found</h3>
                    <div class="alert alert-info">
                        <p>${result.message}</p>
                        ${result.desiredSections ? 
                            `<p><strong>Your desired sections:</strong> ${result.desiredSections.join(', ')}</p>` : 
                            '<p>Please update your profile to add desired sections.</p>'
                        }
                    </div>
                `;
                return;
            }
            
            if (result.type === 'multiple') {
                let html = '<h3>Available Swaps (Priority Order)</h3>';
                
                result.swaps.forEach((swap, index) => {
                    html += `
                        <div class="swap-option" style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
                            <h4 style="color: var(--primary-color);">
                                Priority ${swap.priority}: ${currentUser.current_section} → Section ${swap.targetSection}
                            </h4>
                    `;
                    
                    if (swap.type === 'direct') {
                        html += `<div class="alert alert-success">
                            <strong>Direct Swap Available!</strong><br>
                            <strong>Partners available:</strong><br>`;
                        
                        swap.partners.forEach(partner => {
                            html += `• ${partner.name} (${partner.roll_number}) - Section ${partner.current_section}<br>`;
                        });
                        
                        html += `</div>`;
                    } else if (swap.type === 'multi') {
                        html += `<div class="alert alert-warning">
                            <strong>Multi-Step Swap Available!</strong><br>
                            <strong>Swap chain:</strong><br>`;
                        
                        swap.path.forEach((step, i) => {
                            html += `${i + 1}. ${step.student ? step.student.name + ' (' + step.student.roll_number + ')' : 'Student'} moves from Section ${step.from} to Section ${step.to}<br>`;
                        });
                        
                        html += `</div>`;
                    }
                    
                    html += '</div>';
                });
                
                html += `
                    <div class="alert alert-info" style="margin-top: 20px;">
                        <strong>Next Steps:</strong><br>
                        1. Contact the swap partner(s) to confirm interest<br>
                        2. Complete the swap through official KIIT procedures<br>
                        3. Verify with your academic office before making changes
                    </div>
                `;
                
                resultsDiv.innerHTML = html;
            }
        }
    </script>
</body>
</html>